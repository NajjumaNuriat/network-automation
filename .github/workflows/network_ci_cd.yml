name: Network Configuration CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  network-automation-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install netmiko paramiko

      - name: Test connectivity to switch
        env:
          SWITCH_IP: ${{ secrets.SWITCH_IP }}
          SWITCH_USERNAME: ${{ secrets.SWITCH_USERNAME }}
          SWITCH_PASSWORD: ${{ secrets.SWITCH_PASSWORD }}
        run: |
          echo "Testing connection to switch at $SWITCH_IP"
          python -c "
          from netmiko import ConnectHandler
          import os
          try:
              device = {
                  'device_type': 'cisco_ios',
                  'ip': os.getenv('SWITCH_IP'),
                  'username': os.getenv('SWITCH_USERNAME'),
                  'password': os.getenv('SWITCH_PASSWORD'),
                  'timeout': 30,
              }
              connection = ConnectHandler(**device)
              output = connection.send_command('show version')
              print('✓ Successfully connected to switch')
              print('Switch model:', output.split('\\n')[0])
              connection.disconnect()
          except Exception as e:
              print('✗ Connection failed:', str(e))
              exit(1)
          "

      - name: Run VLAN automation test
        env:
          SWITCH_IP: ${{ secrets.SWITCH_IP }}
          SWITCH_USERNAME: ${{ secrets.SWITCH_USERNAME }}
          SWITCH_PASSWORD: ${{ secrets.SWITCH_PASSWORD }}
          SWITCH_SECRET: ${{ secrets.SWITCH_SECRET }}
        run: |
          echo "Running VLAN automation test..."
          python scripts/test_vlan_automation.py
